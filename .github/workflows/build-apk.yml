name: Build Android APK (Fix Wrapper + Plugins)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install Gradle CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gradle

      - name: Fix project structure
        run: |
          mkdir -p app/src/main/java
          mkdir -p app/src/main/res
          mkdir -p gradle/wrapper
          echo "✅ Estrutura básica criada"

      - name: Create root build.gradle
        run: |
          echo "buildscript {" > build.gradle
          echo "    repositories { google(); mavenCentral() }" >> build.gradle
          echo "    dependencies { classpath 'com.android.tools.build:gradle:8.2.0' }" >> build.gradle
          echo "}" >> build.gradle
          echo "allprojects { repositories { google(); mavenCentral() } }" >> build.gradle

      - name: Create settings.gradle
        run: |
          echo "rootProject.name = 'HYPERBOOST-FF-Shizuco'" > settings.gradle
          echo "include ':app'" >> settings.gradle

      - name: Create app/build.gradle
        run: |
          mkdir -p app
          echo "plugins { id 'com.android.application' }" > app/build.gradle
          echo "android {" >> app/build.gradle
          echo "    namespace 'com.leozito.hyperboostff'" >> app/build.gradle
          echo "    compileSdk 33" >> app/build.gradle
          echo "    defaultConfig {" >> app/build.gradle
          echo "        applicationId 'com.leozito.hyperboostff'" >> app/build.gradle
          echo "        minSdk 21" >> app/build.gradle
          echo "        targetSdk 33" >> app/build.gradle
          echo "        versionCode 1" >> app/build.gradle
          echo "        versionName '1.0'" >> app/build.gradle
          echo "    }" >> app/build.gradle
          echo "    buildTypes { release { minifyEnabled false } }" >> app/build.gradle
          echo "}" >> app/build.gradle
          echo "dependencies {" >> app/build.gradle
          echo "    implementation 'androidx.core:core-ktx:1.12.0'" >> app/build.gradle
          echo "    implementation 'androidx.appcompat:appcompat:1.7.0'" >> app/build.gradle
          echo "    implementation 'com.google.android.material:material:1.11.0'" >> app/build.gradle
          echo "}" >> app/build.gradle

      - name: Create AndroidManifest.xml
        run: |
          mkdir -p app/src/main
          echo '<manifest xmlns:android="http://schemas.android.com/apk/res/android" package="com.leozito.hyperboostff">' > app/src/main/AndroidManifest.xml
          echo '    <application android:label="HyperBoost FF" android:allowBackup="true" android:supportsRtl="true">' >> app/src/main/AndroidManifest.xml
          echo '        <activity android:name=".MainActivity">' >> app/src/main/AndroidManifest.xml
          echo '            <intent-filter>' >> app/src/main/AndroidManifest.xml
          echo '                <action android:name="android.intent.action.MAIN" />' >> app/src/main/AndroidManifest.xml
          echo '                <category android:name="android.intent.category.LAUNCHER" />' >> app/src/main/AndroidManifest.xml
          echo '            </intent-filter>' >> app/src/main/AndroidManifest.xml
          echo '        </activity>' >> app/src/main/AndroidManifest.xml
          echo '    </application>' >> app/src/main/AndroidManifest.xml
          echo '</manifest>' >> app/src/main/AndroidManifest.xml

      - name: Regenerate Gradle Wrapper
        run: |
          echo "task wrapper(type: Wrapper) { gradleVersion = '8.7' }" > temp.gradle
          gradle -b temp.gradle wrapper
          cp -v gradle/wrapper/* gradle/wrapper/
          chmod +x gradlew
          rm temp.gradle
          echo "✅ Gradle Wrapper regenerado!"

      - name: Verify Gradle Wrapper
        run: java -cp gradle/wrapper/gradle-wrapper.jar org.gradle.wrapper.GradleWrapperMain --version

      - name: Build Release APK
        run: ./gradlew assembleRelease

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: app/build/outputs/apk/release/*.apk
