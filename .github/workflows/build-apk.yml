name: Build Android APK (Fix Wrapper + Plugins)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install Gradle CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gradle

      - name: Fix project structure
        run: |
          mkdir -p app/src/main/java
          mkdir -p app/src/main/res
          mkdir -p gradle/wrapper
          echo "✅ Estrutura básica criada"

      - name: Create build.gradle (root)
        run: |
          cat > build.gradle <<'EOF'
buildscript {
    repositories {
        google()
        mavenCentral()
    }
    dependencies {
        classpath 'com.android.tools.build:gradle:8.2.0'
    }
}

allprojects {
    repositories {
        google()
        mavenCentral()
    }
}
EOF

      - name: Create settings.gradle
        run: |
          cat > settings.gradle <<'EOF'
rootProject.name = "HYPERBOOST-FF-Shizuco"
include ':app'
EOF

      - name: Create app/build.gradle
        run: |
          cat > app/build.gradle <<'EOF'
plugins {
    id 'com.android.application'
}

android {
    namespace "com.leozito.hyperboostff"
    compileSdk 33

    defaultConfig {
        applicationId "com.leozito.hyperboostff"
        minSdk 21
        targetSdk 33
        versionCode 1
        versionName "1.0"
    }

    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }
    }
}

dependencies {
    implementation 'androidx.core:core-ktx:1.12.0'
    implementation 'androidx.appcompat:appcompat:1.7.0'
    implementation 'com.google.android.material:material:1.11.0'
}
EOF

      - name: Create AndroidManifest.xml
        run: |
          mkdir -p app/src/main
          cat > app/src/main/AndroidManifest.xml <<'EOF'
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.leozito.hyperboostff">
    <application
        android:allowBackup="true"
        android:label="HyperBoost FF"
        android:supportsRtl="true">
        <activity android:name=".MainActivity">
            <intent-filter>
                <action android:name="android.intent.action.MAIN" />
                <category android:name="android.intent.category.LAUNCHER" />
            </intent-filter>
        </activity>
    </application>
</manifest>
EOF

      - name: Regenerate Gradle Wrapper
        run: |
          echo "task wrapper(type: Wrapper) { gradleVersion = '8.7' }" > temp.gradle
          gradle -b temp.gradle wrapper
          cp -v gradle/wrapper/* gradle/wrapper/
          chmod +x gradlew
          rm temp.gradle
          echo "✅ Gradle Wrapper regenerado!"

      - name: Verify Gradle Wrapper
        run: java -cp gradle/wrapper/gradle-wrapper.jar org.gradle.wrapper.GradleWrapperMain --version

      - name: Build Release APK
        run: ./gradlew assembleRelease

      - name: Upload APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: app-release-apk
          path: app/build/outputs/apk/release/*.apk
