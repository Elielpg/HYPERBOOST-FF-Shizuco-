name: Autogenerate Gradle Wrapper & Fix Missing Files

on:
  workflow_dispatch:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  prepare-and-generate:
    name: Gerar wrapper e criar arquivos faltantes
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install Gradle tool
        uses: gradle/gradle-build-action@v2

      - name: Show repo root (debug)
        run: ls -la

      - name: Ensure gradle/wrapper folder exists
        run: mkdir -p gradle/wrapper

      - name: Create gradle-wrapper.properties if missing
        run: |
          if [ ! -f gradle/wrapper/gradle-wrapper.properties ]; then
            cat > gradle/wrapper/gradle-wrapper.properties <<'EOF'
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
distributionUrl=https\://services.gradle.org/distributions/gradle-8.7-bin.zip
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
EOF
            echo "Created gradle/wrapper/gradle-wrapper.properties"
          else
            echo "gradle-wrapper.properties already exists"
          fi

      - name: Create minimal root build.gradle if missing
        run: |
          if [ ! -f build.gradle ]; then
            cat > build.gradle <<'EOF'
buildscript {
    repositories {
        google()
        mavenCentral()
    }
    dependencies {
        classpath 'com.android.tools.build:gradle:8.2.0'
    }
}

allprojects {
    repositories {
        google()
        mavenCentral()
    }
}
EOF
            echo "Created root build.gradle"
          else
            echo "root build.gradle exists"
          fi

      - name: Create settings.gradle if missing
        run: |
          if [ ! -f settings.gradle ] && [ ! -f settings.gradle.kts ]; then
            cat > settings.gradle <<'EOF'
rootProject.name = "HYPERBOOST-FF-Shizuco"
include ':app'
EOF
            echo "Created settings.gradle"
          else
            echo "settings.gradle exists"
          fi

      - name: Create minimal app module if missing
        run: |
          if [ ! -d app ]; then
            mkdir -p app/src/main/java
            mkdir -p app/src/main/res
            cat > app/build.gradle <<'EOF'
plugins {
    id 'com.android.application'
}

android {
    compileSdk 34
    defaultConfig {
        applicationId "com.leozito.hyperboostff"
        minSdk 21
        targetSdk 34
        versionCode 1
        versionName "1.0"
    }
}
dependencies {}
EOF
            echo "Created minimal app module (app/build.gradle and folders)"
          else
            echo "app module exists"
          fi

      - name: Create gradlew script if missing
        run: |
          if [ ! -f gradlew ]; then
            cat > gradlew <<'EOF'
#!/usr/bin/env sh
APP_BASE_NAME=`basename "$0"`
PRG="$0"
while [ -h "$PRG" ]; do
  ls=`ls -ld "$PRG"`
  link=`expr "$ls" : '.*-> \(.*\)$'`
  if expr "$link" : '/.*' > /dev/null; then
    PRG="$link"
  else
    PRG=`dirname "$PRG"`"/$link"
  fi
done
SAVED="`pwd`"
cd "`dirname \"$PRG\"`/" >/dev/null
APP_HOME="`pwd -P`"
cd "$SAVED" >/dev/null
CLASSPATH=$APP_HOME/gradle/wrapper/gradle-wrapper.jar
exec "$JAVA_HOME/bin/java" -classpath "$CLASSPATH" org.gradle.wrapper.GradleWrapperMain "$@"
EOF
            chmod +x gradlew
            echo "Created gradlew"
          else
            echo "gradlew exists"
          fi

      - name: Create gradlew.bat if missing
        run: |
          if [ ! -f gradlew.bat ]; then
            cat > gradlew.bat <<'EOF'
@echo off
set DIRNAME=%~dp0
if "%DIRNAME%" == "" set DIRNAME=.
set APP_HOME=%DIRNAME%
set CLASSPATH=%APP_HOME%\gradle\wrapper\gradle-wrapper.jar
"%JAVA_HOME%\bin\java.exe" -classpath "%CLASSPATH%" org.gradle.wrapper.GradleWrapperMain %*
EOF
            echo "Created gradlew.bat"
          else
            echo "gradlew.bat exists"
          fi

      - name: Generate gradle wrapper in isolated temp project (if jar missing or invalid)
        run: |
          set -e
          need_gen=false
          if [ ! -f gradle/wrapper/gradle-wrapper.jar ]; then
            need_gen=true
            echo "gradle-wrapper.jar not found -> will generate"
          else
            if ! java -cp gradle/wrapper/gradle-wrapper.jar org.gradle.wrapper.GradleWrapperMain --version >/dev/null 2>&1; then
              need_gen=true
              echo "gradle-wrapper.jar present but seems invalid -> will regenerate"
            else
              echo "gradle-wrapper.jar exists and looks valid"
            fi
          fi

          if [ "$need_gen" = "true" ]; then
            echo "Creating temp project to generate wrapper..."
            rm -rf /tmp/temp-wrapper-project || true
            mkdir -p /tmp/temp-wrapper-project
            cd /tmp/temp-wrapper-project
            # create minimal settings and build that define wrapper task
            cat > settings.gradle <<'EOF'
rootProject.name = "temp-wrapper-project"
EOF
            cat > build.gradle <<'EOF'
task wrapper(type: Wrapper) {
  gradleVersion = '8.7'
}
EOF
            # invoke gradle installed by gradle/gradle-build-action
            gradle wrapper --no-daemon --warning-mode=none
            mkdir -p "$GITHUB_WORKSPACE/gradle/wrapper"
            cp -v gradle/wrapper/* "$GITHUB_WORKSPACE/gradle/wrapper/" || true
            cd "$GITHUB_WORKSPACE"
            rm -rf /tmp/temp-wrapper-project
            echo "Wrapper generated and copied to gradle/wrapper/"
          fi

      - name: Ensure gradlew is executable
        run: chmod +x gradlew || true

      - name: Show wrapper files
        run: ls -la gradle/wrapper || true

      - name: Commit and push changes (if any)
        env:
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
        run: |
          git config user.name "$GIT_AUTHOR_NAME"
          git config user.email "$GIT_AUTHOR_EMAIL"
          git add -A
          if ! git diff --staged --quiet; then
            git commit -m "Auto: generate gradle wrapper & create missing project files"
            git push
          else
            echo "No changes to commit"
          fi
