name: Fix Gradle Wrapper (stable)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  fix-wrapper:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install Gradle tool (for wrapper generation)
        uses: gradle/gradle-build-action@v2

      - name: Ensure gradle/wrapper dir exists
        run: |
          mkdir -p gradle/wrapper

      - name: Create gradle-wrapper.properties (if missing)
        run: |
          if [ ! -f gradle/wrapper/gradle-wrapper.properties ]; then
            cat > gradle/wrapper/gradle-wrapper.properties <<'EOF'
distributionBase=GRADLE_USER_HOME
distributionPath=wrapper/dists
distributionUrl=https\://services.gradle.org/distributions/gradle-8.7-bin.zip
zipStoreBase=GRADLE_USER_HOME
zipStorePath=wrapper/dists
EOF
            echo "created gradle-wrapper.properties"
          else
            echo "gradle-wrapper.properties already exists"
          fi

      - name: Recreate gradlew scripts (if missing)
        run: |
          if [ ! -f gradlew ]; then
            cat > gradlew <<'EOF'
#!/usr/bin/env sh
DIR="$(cd "$(dirname "$0")" && pwd)"
java -Xmx64m -cp "$DIR/gradle/wrapper/gradle-wrapper.jar" org.gradle.wrapper.GradleWrapperMain "$@"
EOF
            chmod +x gradlew
            echo "created gradlew"
          else
            echo "gradlew exists"
          fi

          if [ ! -f gradlew.bat ]; then
            cat > gradlew.bat <<'EOF'
@echo off
set DIR=%~dp0
java -Xmx64m -cp "%DIR%\gradle\wrapper\gradle-wrapper.jar" org.gradle.wrapper.GradleWrapperMain %*
EOF
            echo "created gradlew.bat"
          else
            echo "gradlew.bat exists"
          fi

      - name: Generate gradle-wrapper.jar in isolated temp project (if missing or invalid)
        run: |
          need_gen=false
          if [ ! -f gradle/wrapper/gradle-wrapper.jar ]; then
            need_gen=true
            echo "gradle-wrapper.jar missing -> will generate"
          else
            if ! java -cp gradle/wrapper/gradle-wrapper.jar org.gradle.wrapper.GradleWrapperMain --version >/dev/null 2>&1; then
              need_gen=true
              echo "gradle-wrapper.jar invalid -> will regenerate"
            else
              echo "gradle-wrapper.jar exists and is valid"
            fi
          fi

          if [ "$need_gen" = "true" ]; then
            TMPDIR="/tmp/temp-wrapper-$$"
            rm -rf "$TMPDIR" || true
            mkdir -p "$TMPDIR"
            cat > "$TMPDIR/settings.gradle" <<'EOF'
rootProject.name = "temp-wrapper-project"
EOF
            cat > "$TMPDIR/build.gradle" <<'EOF'
task wrapper(type: Wrapper) {
  gradleVersion = '8.7'
}
EOF
            (cd "$TMPDIR" && gradle wrapper --no-daemon --warning-mode=none)
            mkdir -p gradle/wrapper
            cp -v "$TMPDIR/gradle/wrapper/"* gradle/wrapper/ || true
            rm -rf "$TMPDIR"
            echo "copied gradle wrapper files to gradle/wrapper/"
          fi

      - name: Show wrapper files
        run: ls -la gradle/wrapper || true

      - name: Commit and push wrapper files (if changed)
        env:
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
        run: |
          git config user.name "$GIT_AUTHOR_NAME"
          git config user.email "$GIT_AUTHOR_EMAIL"
          git add gradle gradlew gradlew.bat || true
          if ! git diff --staged --quiet; then
            git commit -m "chore: recreate gradle wrapper files (auto)" || true
            git push || true
            echo "Committed and pushed wrapper files."
          else
            echo "No changes to commit."
          fi
