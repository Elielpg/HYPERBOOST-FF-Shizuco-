name: Build Android APK and AAB (Signed)

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Android SDK 33
        run: |
          sudo apt-get update
          sudo apt-get install -y wget unzip
          wget https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
          unzip -q commandlinetools-linux-9477386_latest.zip -d android-sdk
          sudo mv android-sdk /usr/local/android-sdk
          yes | /usr/local/android-sdk/cmdline-tools/bin/sdkmanager --sdk_root=/usr/local/android-sdk "platforms;android-33" "build-tools;33.0.2" "platform-tools"
          export ANDROID_HOME=/usr/local/android-sdk
          export PATH=$PATH:$ANDROID_HOME/cmdline-tools/bin:$ANDROID_HOME/platform-tools
          echo "âœ… Android SDK 33 instalado"

      - name: Prepare project structure
        run: |
          mkdir -p app/src/main/java
          mkdir -p app/src/main/res
          mkdir -p gradle/wrapper

      - name: Create root build.gradle
        run: |
          echo "buildscript {" > build.gradle
          echo "    repositories { google(); mavenCentral() }" >> build.gradle
          echo "    dependencies { classpath 'com.android.tools.build:gradle:8.2.0' }" >> build.gradle
          echo "}" >> build.gradle
          echo "allprojects { repositories { google(); mavenCentral() } }" >> build.gradle

      - name: Create settings.gradle
        run: |
          echo "rootProject.name = 'HYPERBOOST-FF-Shizuco'" > settings.gradle
          echo "include ':app'" >> settings.gradle

      - name: Create app/build.gradle
        run: |
          mkdir -p app
          echo "plugins { id 'com.android.application' }" > app/build.gradle
          echo "android {" >> app/build.gradle
          echo "    namespace 'com.leozito.hyperboostff'" >> app/build.gradle
          echo "    compileSdk 33" >> app/build.gradle
          echo "" >> app/build.gradle
          echo "    signingConfigs {" >> app/build.gradle
          echo "        release {" >> app/build.gradle
          echo "            storeFile file('release.keystore')" >> app/build.gradle
          echo "            storePassword '123456'" >> app/build.gradle
          echo "            keyAlias 'releaseKey'" >> app/build.gradle
          echo "            keyPassword '123456'" >> app/build.gradle
          echo "        }" >> app/build.gradle
          echo "    }" >> app/build.gradle
          echo "" >> app/build.gradle
          echo "    defaultConfig {" >> app/build.gradle
          echo "        applicationId 'com.leozito.hyperboostff'" >> app/build.gradle
          echo "        minSdk 21" >> app/build.gradle
          echo "        targetSdk 33" >> app/build.gradle
          echo "        versionCode 1" >> app/build.gradle
          echo "        versionName '1.0'" >> app/build.gradle
          echo "    }" >> app/build.gradle
          echo "" >> app/build.gradle
          echo "    compileOptions {" >> app/build.gradle
          echo "        sourceCompatibility JavaVersion.VERSION_17" >> app/build.gradle
          echo "        targetCompatibility JavaVersion.VERSION_17" >> app/build.gradle
          echo "    }" >> app/build.gradle
          echo "" >> app/build.gradle
          echo "    buildTypes {" >> app/build.gradle
          echo "        release {" >> app/build.gradle
          echo "            signingConfig signingConfigs.release" >> app/build.gradle
          echo "            minifyEnabled false" >> app/build.gradle
          echo "            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'" >> app/build.gradle
          echo "        }" >> app/build.gradle
          echo "    }" >> app/build.gradle
          echo "}" >> app/build.gradle
          echo "" >> app/build.gradle
          echo "dependencies {" >> app/build.gradle
          echo "    implementation 'androidx.core:core-ktx:1.12.0'" >> app/build.gradle
          echo "    implementation 'androidx.appcompat:appcompat:1.7.0'" >> app/build.gradle
          echo "    implementation 'com.google.android.material:material:1.11.0'" >> app/build.gradle
          echo "}" >> app/build.gradle

      - name: Create AndroidManifest.xml
        run: |
          mkdir -p app/src/main
          echo '<manifest xmlns:android="http://schemas.android.com/apk/res/android" package="com.leozito.hyperboostff">' > app/src/main/AndroidManifest.xml
          echo '    <application android:label="HyperBoost FF" android:allowBackup="true" android:supportsRtl="true">' >> app/src/main/AndroidManifest.xml
          echo '        <activity android:name=".MainActivity">' >> app/src/main/AndroidManifest.xml
          echo '            <intent-filter>' >> app/src/main/AndroidManifest.xml
          echo '                <action android:name="android.intent.action.MAIN" />' >> app/src/main/AndroidManifest.xml
          echo '                <category android:name="android.intent.category.LAUNCHER" />' >> app/src/main/AndroidManifest.xml
          echo '            </intent-filter>' >> app/src/main/AndroidManifest.xml
          echo '        </activity>' >> app/src/main/AndroidManifest.xml
          echo '    </application>' >> app/src/main/AndroidManifest.xml
          echo '</manifest>' >> app/src/main/AndroidManifest.xml

      - name: Generate Keystore
        run: |
          keytool -genkeypair -v -keystore release.keystore -keyalg RSA -keysize 2048 -validity 10000 -alias releaseKey -storepass 123456 -keypass 123456 -dname "CN=HyperBoostFF,O=Eliel,C=BR"
          echo "ðŸ” Keystore gerado com sucesso!"

      - name: Regenerate Gradle Wrapper
        run: |
          echo "task wrapper(type: Wrapper) { gradleVersion = '8.7' }" > temp.gradle
          gradle -b temp.gradle wrapper
          chmod +x gradlew
          rm temp.gradle
          echo "âœ… Gradle Wrapper regenerado!"

      - name: Build Release APK and AAB
        run: |
          ./gradlew assembleRelease
          ./gradlew bundleRelease

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: HyperBoostFF-Outputs
          path: |
            app/build/outputs/apk/release/*.apk
            app/build/outputs/bundle/release/*.aab
